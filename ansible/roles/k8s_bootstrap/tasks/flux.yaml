---
- name: Install Flux Operator using Helm
  kubernetes.core.helm:
    name: flux-operator
    chart_ref: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator
    namespace: flux-system
    create_namespace: true
    kubeconfig: "{{ playbook_dir }}/../../kubeconfig"
  register: flux_operator_result

- name: Find all manifest files in kubernetes/flux
  ansible.builtin.find:
    paths: "{{ playbook_dir }}/../../kubernetes/flux"
    patterns: "*.yaml"
  register: flux_manifests

- name: Apply each Flux manifest
  kubernetes.core.k8s:
    kubeconfig: "{{ playbook_dir }}/../../kubeconfig"
    state: present
    src: "{{ item.path }}"
  loop: "{{ flux_manifests.files }}"
  register: flux_resources_apply_result
