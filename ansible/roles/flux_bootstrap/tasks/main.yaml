---
- name: Install Flux and point to repository
  ansible.builtin.shell: |
    flux install --components-extra=image-reflector-controller,image-automation-controller
  args:
    executable: /bin/bash
  register: flux_install_result
  changed_when: "'Flux installed' in flux_install_result.stdout"

- name: Apply Flux Kustomization
  ansible.builtin.shell: |
    flux create kustomization flux-system \
      --source=flux-system \
      --path="./kubernetes/flux" \
      --prune=true \
      --interval=10m \
      --export > /tmp/flux-kustomization.yaml
    kubectl apply -f /tmp/flux-kustomization.yaml
  args:
    executable: /bin/bash
  register: kustomization_result
  changed_when: "'kustomization.kustomize.toolkit.fluxcd.io/flux-system created' in kustomization_result.stdout or 'kustomization.kustomize.toolkit.fluxcd.io/flux-system configured' in kustomization_result.stdout"